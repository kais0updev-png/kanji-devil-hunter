# 🔧 管理者機能 - 問題報告システム

**実装日**: 2026-02-07  
**機能概要**: 実際のプレイ中におかしな設問を発見した際、管理者が報告・記録できる仕組み

---

## 📋 機能一覧

### ✅ 実装済み機能

1. **問題報告チェックボックス**
   - 学習画面の4択ボタン下に配置
   - 薄いグレーで目立たないデザイン（opacity: 0.3）
   - ホバー時に少し濃くなる（opacity: 0.6）
   - チェック済み時は赤色に変化

2. **報告データの保存**
   - LocalStorageに自動保存（`csmQuestionReports`）
   - 重複チェック（同じ問題IDは1回のみ報告可能）
   - ユーザー回答と正誤判定を記録

3. **管理者画面**
   - ヘッダーの「ADMIN」ボタンから遷移（目立たないグレーボタン）
   - 報告一覧の表示（報告日時順・ステージ順でソート可能）
   - 個別削除・全削除機能
   - CSV出力機能（Excel対応、BOM付きUTF-8）

---

## 🎯 使い方

### 1. 問題を報告する

1. 学習画面で問題に回答する
2. おかしな問題を見つけたら、「この問題、なんか変です」をチェック
3. チェックすると即座にLocalStorageに保存される
4. 同じ問題は1回のみ報告可能（重複チェック）

### 2. 報告一覧を確認する

1. ヘッダーの「ADMIN」ボタンをクリック
2. 管理者画面に遷移
3. 報告件数と一覧が表示される

### 3. 報告をソートする

- **報告日時順**: 最新の報告が上に表示される（デフォルト）
- **ステージ順**: Stage 1 → Stage 10の順に表示される

### 4. 報告を削除する

- **個別削除**: 各報告の「削除」ボタンをクリック
- **全削除**: 「🗑️ 全削除」ボタンをクリック（確認ダイアログあり）

### 5. CSV出力する

1. 「📊 CSV出力」ボタンをクリック
2. ファイル名: `question-reports-YYYY-MM-DD.csv`
3. BOM付きUTF-8で出力（Excelで日本語が正しく表示される）

---

## 📊 CSV出力フォーマット

| Column | Description | Example |
|--------|-------------|---------|
| Report ID | 報告ID | `report-1709876543210-abc123` |
| Question ID | 問題ID | `s1-q001` |
| Stage | ステージ番号 | `1` |
| Kanji | 対象漢字 | `一` |
| Type | 問題タイプ | `reading` |
| Question | 問題文 | `「一人」の「一」の読み方を選びなさい。` |
| Choice 1 | 選択肢1 | `ひと` |
| Choice 2 | 選択肢2 | `いち` |
| Choice 3 | 選択肢3 | `かず` |
| Choice 4 | 選択肢4 | `ひとつ` |
| Correct Answer (0-3) | 正解番号 | `0` |
| User Answer (0-3) | ユーザー回答 | `1` |
| Is Correct | 正誤 | `false` |
| Explanation | 解説 | `一は「いち」「ひと（つ）」と読みます` |
| Reported At | 報告日時 | `2026-02-07T12:34:56.789Z` |

---

## 💾 データ構造

### QuestionReport (LocalStorage)

```javascript
{
  id: 'report-1709876543210-abc123',          // 報告ID（自動生成）
  questionId: 's1-q001',                      // 問題ID
  stageId: 1,                                 // ステージ番号
  kanji: '一',                                // 対象漢字
  questionType: 'reading',                    // 問題タイプ
  question: '「一人」の「一」の読み方を選びなさい。',  // 問題文
  choices: ['ひと', 'いち', 'かず', 'ひとつ'], // 選択肢（4つ）
  correctAnswer: 0,                           // 正解番号（0-3）
  explanation: '一は「いち」「ひと（つ）」と読みます',  // 解説
  reportedAt: '2026-02-07T12:34:56.789Z',     // 報告日時（ISO 8601）
  userAnswer: 1,                              // ユーザー回答（0-3、任意）
  isCorrect: false                            // 正誤判定（boolean、任意）
}
```

### LocalStorage Key

- `csmQuestionReports`: 全報告データの配列

---

## 🎨 デザイン仕様

### チェックボックス（目立たない）

- **配置**: 4択ボタンの下、進捗バーの上
- **デフォルト**: 薄いグレー（opacity: 0.3）
- **ホバー**: 少し濃くなる（opacity: 0.6）
- **チェック済み**: 赤色（#ff6b6b、opacity: 0.8）
- **フォントサイズ**: 11px

### ADMINボタン（目立たないが統一感あり）

- **配置**: ヘッダーの「REVIEW」の右
- **背景色**: グレー（#666）
- **不透明度**: 50%（デフォルト）、80%（ホバー）
- **フォントサイズ**: 16px（HOME・REVIEWと同じ）
- **パディング**: 8px 16px（HOME・REVIEWと同じ）
- **フォント太さ**: medium（HOME・REVIEWと同じ）

### 管理者画面

- **最大幅**: 1400px
- **背景色**: ダークグレー（#1A1A1A）
- **テーブル**: スティッキーヘッダー、赤色ヘッダー
- **ボタン**: ダークテーマ、ホバー時に赤色ボーダー

---

## 🧪 動作確認項目

### チェックボックス機能

- ✅ 問題画面に「この問題、なんか変です」チェックボックスが表示される
- ✅ チェックボックスは薄いグレーで目立たない
- ✅ チェックを入れるとLocalStorageに保存される
- ✅ 同じ問題は1回のみ報告可能（重複チェック）
- ✅ 次の問題に移動するとチェックボックスがリセットされる
- ✅ ユーザー回答と正誤判定が記録される

### 管理者画面

- ✅ ヘッダーにADMINボタンが表示される（目立たない）
- ✅ ADMINボタンをクリックすると管理者画面に遷移
- ✅ 報告一覧が表示される
- ✅ 報告日時順・ステージ順でソートできる
- ✅ CSV出力ボタンで報告データをダウンロードできる
- ✅ 個別削除ボタンで報告を削除できる
- ✅ 全削除ボタンで全報告を削除できる（確認ダイアログあり）

### CSV出力

- ✅ UTF-8（BOM付き）で出力される
- ✅ Excelで開いて日本語が正しく表示される
- ✅ 全15列のデータが正しく出力される
- ✅ 問題文・選択肢のカンマ・改行がエスケープされる
- ✅ ファイル名: `question-reports-YYYY-MM-DD.csv`

---

## 📁 実装ファイル

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `index.html` | チェックボックス追加、管理者画面HTML追加、ADMINボタン追加 |
| `js/chainsaw-app.js` | 報告機能関数追加、管理者画面ロジック追加、checkAnswer更新 |
| `css/chainsaw-design.css` | 管理者機能のCSSスタイル追加（約250行） |

### 新規関数（js/chainsaw-app.js）

```javascript
// 問題報告機能
saveQuestionReport(question, userAnswer, isCorrect)
getQuestionReports()
deleteQuestionReport(reportId)
clearAllQuestionReports()
exportReportsToCSV()

// 管理者画面
showAdminScreen()
renderReportsList()
confirmDeleteReport(reportId)
confirmClearAllReports()
exportReportsCSV()
```

---

## 🚀 今後の拡張案

### Phase 5-B: 報告機能の強化

- [ ] 報告時にコメントを追加できる機能
- [ ] 報告データをサーバーに送信する機能
- [ ] 報告された問題を自動的に除外する機能
- [ ] 報告履歴のフィルタ機能（問題タイプ別、正誤別）

### Phase 5-C: 分析機能

- [ ] 最も報告が多い問題トップ10
- [ ] 問題タイプ別の報告数グラフ
- [ ] ステージ別の報告数グラフ
- [ ] 報告率の推移（日別）

---

## 📝 まとめ

**管理者機能（問題報告システム）が完全実装されました！**

- ✅ チェックボックスが目立たない（opacity: 0.3）
- ✅ ADMINボタンが目立たない（グレー、小さめ）
- ✅ 報告データがLocalStorageに保存される
- ✅ 管理者画面で報告一覧が表示される
- ✅ CSV出力が正常に動作する
- ✅ 既存機能に影響を与えていない
- ✅ JSエラー0件、コンソール警告0件

**🔧 実際のプレイ中におかしな設問を発見したら、チェックボックスで報告してください！**
